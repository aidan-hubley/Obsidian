#DatabseConcepts
# How to work with common table expressions
A common table expression ( CTE) is a new feature of MySQL 8.0 that allows you to code an expression that defines a named temporary result set. You can use CTEs to simplify complex queries that use subque1ies. This can make your code easier to read and maintain. In addition, you can use a CTE to loop through nested structures.
## How to code a CTE
- Figure 7-13 shows how to use a CTE to simplify the complex query presented in figure 7-11 . To start, the statement for the query begins with the WITH keyword to indicate that you are about to define a CTE. Then, it specifies summary as the name for the first result set, followed by the AS keyword, followed by a SELECT statement enclosed in parentheses that defines the 1·esult set. In this figure, for example, this statement returns the same result set as the subqueries named tl and t2 that were presented in figure 7-11.
- After the frrst CTE is defmed, this example continues by defining a second CTE named top_in_state. To start, a comma is coded to separate the two CTEs. Then, this query specifies top_in_state as the name for the second result set, followed by the AS keyword, followed by a SELECT statement enclosed in parentheses that defines the result set. This SELECT statement refers to the summary result set that was defined by the first CTE. When coding multiple CTEs like this, a CTE can refer to any CTEs in the same WITH clause that are coded before it, but it can't refer to CTEs coded after it. As a result, this statement wouldn't work if the two CTEs were coded in the reverse order.
- Finally, the SELECT statement that's coded immediately after the two CTEs uses both of these CTEs just as if they were tables. To do that, this SELECT statement joins the two rest1lt sets, specifies the columns to retrieve, and specifies the sort order. To avoid ambiguous references, each column is qualified by the name for the CTE. If yot1 compare figure 7-13 with figure 7-11, I think you'll agree that the code in figure 7-13 is easier to read. That's partly because the result sets defined by the subqueries aren't nested within the SELECT statement. In addition, I think you'll agree that the code in figure 7-13 is easier to maintain. That's because this query reduces code duplication by only coding the summary subquery in one place, not in two places.
- When using the syntax shown here to define CTEs, you must supply distinct names for all columns defined by the SELECT statement, including calculated values. That way, it's possible for other statements to refer to the columns in the result set. Most of the time, that's all you need to know to be able to work with CTEs. For more information about working with CTEs, you can look up ''WITH Syntax (Common Table Expressions)'' in the documentation for MySQL.
### The syntax of a CTE
![[Pasted image 20220922230358.png]]
### Two CTEs and a query that uses them
![[Pasted image 20220922230417.png]]
### The result set
![[Pasted image 20220922230430.png]]
### Description
- A common table expression (CTE) is a SELECT statement that creates one or more named temporary result sets that can be used by the query that follows. 
- To use a CTE, you code the WITH keyword followed by the definition of the CTE. Then, iminediately after the CTE, you code the statement that uses it. V 
- To code multiple CTEs, separate them with commas. Then, each CTE can refer to itself and any previously defined CTEs in the same WITH clause. 
- To code a recursive CTE, include the RECURSIVE keyword after the WITH keyword. See figure 7-14 for more on recursive CTEs. 
- Although you can use CTEs with SELECT, INSERT, UPDATE, and DELETE statements, you'r·e most likely to use them with SELECT statements. 

## How to code a recursive CTE
- A recursive qLtery is a query that is able to loop through a result set and perform processing to return a final result set. Recursive queries are commonly used to return hierarchical data such as an organizational chart in which a parent element may have one or more child elements, and each child element may have one or more child elements. Prior to MySQL 8.0, a recursive query required using inline views, cursors, and logic to control the flow of the rect1rsive steps. With MySQL 8.0 and later, you can use a recursive CTE to code recursive queries more easily. Figure 7-14 shows how. 
- The top of this figure shows an Employees table where the manager_id column is used to identify the manager for each employee. Here, Cindy Smith is the top level manager since she doesn't have a manager, Elmer Jones and Paulo Locario report to Cindy, and so on. 
- The recursive CTE shown in this figure returns each employee according to their level in the organization chart for the company. To do that, this statement begins by defining a CTE named employees_cte. Note here that the WITH clause includes the RECURSIVE keyword. This is required for recursive common table expressions. If you forget this keyword, you'll get error code 1146: ''Table 'table name' doesn't exist''.
- Within the CTE, two SELECT statements are joined by the UNION ALL operator. Here, the frrst SELECT statement uses the IS NULL operator to return the first row of the result set. Because this statement doesn't refer to the name of the CTE, it is non-recursive. 
- The second SELECT statement creates a loop by referring to the name of the CTE. Specifically, this state1nent joins the Employees table to the employees_cte result set that's defined by the CTE. Because of that, it is a recursive SELECT statement that loops through eacl1 row in the Employees table. With each loop, it adds 1 to the ranking column and appends the current result set to the fmal result set. For example, on the first loop, it appends Elmer Jones and Paulo Locario to the final result set. On the second loop, it appends Ralph Simonian, Thomas Hardy, Olivia Hernandez, and Rhea O'Leary to the final result set. And so on. 
- When coding a recursive CTE, you must follow some rules. First, you must supply a name for each column defined by the CTE. To do that, you just need to make sure to specify a name for each column in the non-recursive query. Second, the rules for coding a union that you learned in chapter 4 still apply. In particular, the two SELECT statements must have the same number of columns and the columns must have compatible data types. 
- Most of the time, that's all you need to know to be able to work with recursive CTEs. However, the goal of this topic is to show a simple recursive CTE to give you a general idea of how they work. For more inf or1nation about working with recursive CTEs, you can start by looking up ''WITH Syntax (Common Table Expressions)'' in the documentation for MySQL and then clicking on the ''Recursive Common Table Expressions'' link.
### The Employees table
![[Pasted image 20220922230650.png]]
### A recursive CTE that returns hierarchical data
![[Pasted image 20220922230719.png]]
### The final result set
![[Pasted image 20220922230733.png]]
### Description
- A recursive query is a query that can loop through a result set and perform processing to return a final result set. A recursive CTE can be used to create a recursive query. 
- A recursive CTE contains a non-recursive SELECT statement followed by a recursive SELECT statement, and these two statements must be connected by the UNION or UNION ALL operator.